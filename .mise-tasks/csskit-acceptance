#!/usr/bin/env bash
#MISE depends=["build"]
#MISE description="Run acceptance tests against `csskit`"
set -eu
set -o pipefail

CSSKIT="./target/debug/csskit"
PASS=$(printf '\033[32m✓\033[0m')
FAIL=$(printf '\033[31m✗\033[0m')
passed=0
failed=0

css_files=$(ls coverage/basic/*.css 2>/dev/null)
if [ -z "$css_files" ]; then
	echo "No CSS test files found!"
	exit 1
fi

QUIET=false
for arg in "$@"; do
	case "$arg" in
	-q | --quiet) QUIET=true ;;
	esac
done

skip_min="coverage/popular/bootstrap.5.3.0.css coverage/popular/foundation.6.7.5.css"

should_skip() {
	local variant="$1"
	local file="$2"
	local skip_list=""
	case "$variant" in
		min) skip_list="$skip_min" ;;
	esac
	for skip in $skip_list; do
		[ "$file" = "$skip" ] && return 0
	done
	return 1
}

check_parse() {
	css_file="$1"
	if $CSSKIT fmt "$css_file" > /dev/null 2>&1; then
		echo " $PASS parse $css_file"
		passed=$((passed + 1))
	else
		echo " $FAIL parse $css_file"
		failed=$((failed + 1))
	fi
}

check_variant() {
	variant="$1"
	css_file="$2"
	base="$3"
	target_file="$base.$variant.css"

	if [ -f "$target_file" ]; then
		if should_skip "$variant" "$css_file"; then
			$QUIET || echo " - $variant $css_file (skipped)"
			return
		fi
		if diff_output=$($CSSKIT "$variant" "$css_file" 2>/dev/null | diff -Z --new-file --color=always --side-by-side --suppress-common-lines - "$target_file" 2>&1); then
			echo " $PASS $variant $css_file"
			passed=$((passed + 1))
		else
			echo " $FAIL $variant $css_file"
			$QUIET || echo "$diff_output"
			failed=$((failed + 1))
		fi
	fi
}

for css in coverage/basic/*.css coverage/popular/*.css; do
	[ -f "$css" ] || continue
	case "$css" in *.min.css | *.fmt.css) continue ;; esac
	base="${css%.css}"

	check_parse "$css"
	check_variant "fmt" "$css" "$base"
	check_variant "min" "$css" "$base"
done

total=$((passed + failed))
if [ "$total" -gt 0 ]; then
	rate=$((100 * passed / total))
	echo "Success rate: $rate%"
fi

[ "$total" -eq 0 ] && {
	echo "No tests were run!"
	exit 1
}

echo "Results: $passed passed, $failed failed"
exit $failed

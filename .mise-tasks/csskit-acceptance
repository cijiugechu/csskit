#!/usr/bin/env bash
#MISE depends=["build"]
#MISE description="Run acceptance tests against `csskit`"
set -eu
set -o pipefail

CSSKIT="./target/debug/csskit"
PASS=$(printf '\033[32m✓\033[0m')
FAIL=$(printf '\033[31m✗\033[0m')
passed=0
failed=0

css_files=$(ls coverage/basic/*.css 2>/dev/null)
if [ -z "$css_files" ]; then
	echo "No CSS test files found!"
	exit 1
fi

QUIET=false
for arg in "$@"; do
	case "$arg" in
	-q | --quiet) QUIET=true ;;
	esac
done

check_variant() {
	variant="$1"
	css_file="$2"
	base="$3"
	target_file="$base.$variant.css"

	if [ -f "$target_file" ]; then
		echo "Checking $css_file against $target_file"
		if diff_output=$($CSSKIT "$variant" "$css_file" 2>/dev/null | diff -Z --new-file --color=always --side-by-side --suppress-common-lines - "$target_file" 2>&1); then
			echo " $PASS $target_file matches"
			passed=$((passed + 1))
		else
			echo " $FAIL $target_file differs"
			$QUIET || echo "$diff_output"
			failed=$((failed + 1))
		fi
	fi
}

for css in coverage/basic/*.css; do
	case "$css" in *.min.css | *.fmt.css) continue ;; esac
	base="${css%.css}"

	check_variant "fmt" "$css" "$base"
	check_variant "min" "$css" "$base"
done

total=$((passed + failed))
if [ "$total" -gt 0 ]; then
	rate=$((100 * passed / total))
	echo "Success rate: $rate%"
fi

[ "$total" -eq 0 ] && {
	echo "No tests were run!"
	exit 1
}

echo "Results: $passed passed, $failed failed"
exit $failed

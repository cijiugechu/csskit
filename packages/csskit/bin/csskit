#!/bin/bash
set -e

SOURCE="${BASH_SOURCE[0]}"
while [ -L "$SOURCE" ]; do
	DIR="$(cd -P "$(dirname "$SOURCE")" >/dev/null 2>&1 && pwd)"
	TARGET="$(readlink "$SOURCE")"
	case "$TARGET" in
	/*) SOURCE="$TARGET" ;;
	*) SOURCE="$DIR/$TARGET" ;;
	esac
done

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${SOURCE}")" && pwd)"

# Detect platform
case "$(uname -s)" in
Linux*) PLATFORM="linux" ;;
Darwin*) PLATFORM="darwin" ;;
MINGW* | MSYS* | CYGWIN*) PLATFORM="win32" ;;
*)
	echo "Unsupported platform: $(uname -s)" >&2
	exit 1
	;;
esac

# Detect architecture
case "$(uname -m)" in
x86_64 | amd64) ARCH="x64" ;;
aarch64 | arm64) ARCH="arm64" ;;
*)
	echo "Unsupported architecture: $(uname -m)" >&2
	exit 1
	;;
esac

# Package/bin name for this platform
PACKAGE_NAME="csskit-${PLATFORM}-${ARCH}"
if [ "$PLATFORM" = "win32" ]; then
	BIN_NAME="csskit.exe"
else
	BIN_NAME="csskit"
fi

# Walk up directory tree to find node_modules with the binary
CURRENT_DIR="$(dirname "$SCRIPT_DIR")"
while [ "$CURRENT_DIR" != "/" ]; do
	# Skip if parent directory is named node_modules to avoid nested node_modules paths
	if [ "$(basename "$CURRENT_DIR")" != "node_modules" ]; then
		BIN_PATH="${CURRENT_DIR}/node_modules/${PACKAGE_NAME}/bin/${BIN_NAME}"

		if [ -f "$BIN_PATH" ]; then
			exec "$BIN_PATH" "$@"
		fi
	fi

	CURRENT_DIR="$(dirname "$CURRENT_DIR")"
done

# Binary not found
echo "Error: csskit binary not found for ${PLATFORM}-${ARCH}" >&2
echo "Please ensure the appropriate platform package is installed:" >&2
echo "  npm install ${PACKAGE_NAME}" >&2
exit 1

name: release
on:
  workflow_run:
    workflows: [test]
    types: [completed]
    branches: [main, release]
  workflow_dispatch:
concurrency:
  group: "release"
  cancel-in-progress: true
permissions:
  contents: write
  id-token: write
  pull-requests: write
jobs:
  build:
    if: |
      ${{
        github.event_name == 'workflow_dispatch' ||
        (
          github.event.workflow_run.conclusion == 'success' &&
          github.repository_owner == 'csskit' &&
          github.ref_name == 'main'
        )
      }}

    strategy:
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            code-target: win32-x64

          - os: windows-latest
            target: aarch64-pc-windows-msvc
            code-target: win32-arm64

          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            code-target: linux-x64

          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            code-target: linux-arm64

          - os: macos-latest
            target: x86_64-apple-darwin
            code-target: darwin-x64

          - os: macos-latest
            target: aarch64-apple-darwin
            code-target: darwin-arm64

    name: Package ${{ matrix.code-target }}
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          submodules: "true"
      - name: Setup
        uses: ./.github/actions/setup
        with:
          key: release-${{ matrix.target }}
      - name: Rustup target
        run: rustup target add ${{ matrix.target }}
      - name: Install arm64 toolchain
        if: matrix.code-target == 'linux-arm64'
        run: sudo apt update && sudo apt install -y gcc-aarch64-linux-gnu
      - name: Build Binary
        run: cargo build --release --target ${{ matrix.target }} -p csskit
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

      - name: Archive Binary
        if: runner.os == 'Windows'
        shell: bash
        run: |
          BIN_NAME=csskit-${{ matrix.code-target }}
          mv target/${{ matrix.target }}/release/csskit.exe $BIN_NAME.exe

      - name: Archive Binary
        if: runner.os != 'Windows'
        run: |
          BIN_NAME=csskit-${{ matrix.code-target }}
          mv target/${{ matrix.target }}/release/csskit $BIN_NAME

      - run: chmod +x csskit-*

      - name: Upload Binary
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          if-no-files-found: error
          name: binary-${{ matrix.code-target }}
          path: csskit-*

  deploy:
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          fetch-depth: 0
      - name: Setup
        uses: ./.github/actions/setup
      - name: Download Artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
      - name: Copy binaries to platform packages
        run: |
          for artifact_dir in binary-*; do
            platform="${artifact_dir#binary-}"
            package_dir="packages/csskit-${platform}"
            mkdir -p "${package_dir}/bin"

            # Copy and rename binary to just 'csskit' or 'csskit.exe' for clean help text
            for binary in "${artifact_dir}"/*; do
              if [[ "$binary" == *.exe ]]; then
                cp "$binary" "${package_dir}/bin/csskit.exe"
              else
                cp "$binary" "${package_dir}/bin/csskit"
              fi
            done
          done
      - name: Ensure binaries are chmod +x
        run: chmod +x packages/csskit-*/bin/*
      - run: tree packages/
      - name: Install Dependencies
        run: npm i
        working-directory: ./packages/csskit
      - name: Release
        run: mise r release-automation
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.RELEASE_PR_PAT }}

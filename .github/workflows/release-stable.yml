name: release-stable
on:
  release:
    types: [published]
concurrency:
  group: "release-stable"
  cancel-in-progress: false
permissions:
  contents: write
  id-token: write
jobs:
  build:
    strategy:
      matrix:
        include:
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            code-target: win32-x64

          - os: windows-latest
            target: aarch64-pc-windows-msvc
            code-target: win32-arm64

          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            code-target: linux-x64

          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            code-target: linux-arm64

          - os: macos-latest
            target: x86_64-apple-darwin
            code-target: darwin-x64

          - os: macos-latest
            target: aarch64-apple-darwin
            code-target: darwin-arm64

    name: Package ${{ matrix.code-target }}
    runs-on: ${{ matrix.os }}
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          submodules: "true"
      - name: Setup
        uses: ./.github/actions/setup
        with:
          key: release-${{ matrix.target }}
      - name: Rustup target
        run: rustup target add ${{ matrix.target }}
      - name: Install arm64 toolchain
        if: matrix.code-target == 'linux-arm64'
        run: sudo apt-get install -y gcc-aarch64-linux-gnu
      - name: Build Binary
        run: cargo build --release --target ${{ matrix.target }} -p csskit
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

      - name: Archive Binary
        if: runner.os == 'Windows'
        shell: bash
        run: |
          BIN_NAME=csskit-${{ matrix.code-target }}
          mv target/${{ matrix.target }}/release/csskit.exe $BIN_NAME.exe

      - name: Archive Binary
        if: runner.os != 'Windows'
        run: |
          BIN_NAME=csskit-${{ matrix.code-target }}
          mv target/${{ matrix.target }}/release/csskit $BIN_NAME

      - run: chmod +x csskit-*

      - name: Upload Binary
        uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
        with:
          if-no-files-found: error
          name: binary-${{ matrix.code-target }}
          path: csskit-*

  deploy-cargo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          # Fetch full history so cargo-release can create commits
          fetch-depth: 0
      - name: Get release version
        run: |
          # Strip 'v' prefix from tag name (e.g., v0.1.0 -> 0.1.0)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      - name: Setup
        uses: ./.github/actions/setup
        with:
          key: release-stable
      - name: Release with cargo-release
        run: |
          git config user.name "Keith Cirkel"
          git config user.email "keithamus@users.noreply.github.com"
          # cargo-release updates workspace.package.version and workspace.dependencies versions
          cargo release --workspace --no-confirm $VERSION
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  deploy-npm:
    env:
      DIST_TAG: latest
    runs-on: ubuntu-latest
    needs: [build]
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Get release version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      - name: Download Artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
      - name: Copy binaries to package
        run: cp binary-*/* packages/csskit/bin
      - name: Ensure binaries are chmod +x
        run: chmod +x packages/csskit/bin/*
      - run: tree
      - name: Install Dependencies
        run: npm i
        working-directory: ./packages/csskit
      - name: Tag Package with release version
        run: npm version ${VERSION} --no-git-tag-version
        working-directory: ./packages/csskit
      - name: Deploy to npm
        run: |
          echo '//registry.npmjs.org/:_authToken=${NODE_AUTH_TOKEN}' >> ~/.npmrc
          npm whoami
          npm pub --provenance --tag $DIST_TAG --access public
        working-directory: ./packages/csskit
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NODE_AUTH_TOKEN }}

  update-release:
    runs-on: ubuntu-latest
    needs: [build, deploy-npm, deploy-cargo]
    steps:
      - name: Checkout
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      - name: Get release version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV
      - name: Download Artifacts
        uses: actions/download-artifact@018cc2cf5baa6db3ef3c5f8a56943fffe632ef53 # v6.0.0
      - name: Update Release
        uses: softprops/action-gh-release@62c96d0c4e8a889135c1f3a25910db8dbe0e85f7 # v2.3.4
        with:
          tag_name: v${{ env.VERSION }}
          files: binary-*/*
          token: ${{ secrets.GITHUB_TOKEN }}
          body: |
            Release version ${{ env.VERSION }}

            Published to npm:
            ```shell
            npm i csskit@${{ env.VERSION }}
            ```

            Published to crates.io:
            ```shell
            cargo add csskit@${{ env.VERSION }}
            ```

name: bench
on:
  pull_request:
    types: [opened, synchronize, reopened, labeled]
jobs:
  build:
    if: contains(github.event.pull_request.labels.*.name, 'bench')
    name: Benchmark on linux
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
    steps:
      - name: Checkout PR
        uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
        with:
          submodules: "true"
      - name: Setup mise
        uses: jdx/mise-action@v3
      - name: Setup
        uses: ./.github/actions/setup
      - name: Download benchmark history
        uses: dawidd6/action-download-artifact@ac66b43f0e6a346234dd65d4d0c8fbb31cb316e5 # v11
        with:
          name: benchmark-history
          workflow: benchmark-tracking.yml
          workflow_conclusion: success
          branch: main
          search_artifacts: true
          path: website/_data
      - name: Run PR branch benchmarks
        run: mise run collect-benchmarks
      - name: Compare benchmark results
        id: compare
        run: |
          HISTORY="website/_data/benchmark-history.json"

          # Extract the latest entry from each
          PR_ENTRY=$(jq '.[0]' "$HISTORY")
          BASE_ENTRY=$(jq '.[1]' "$HISTORY")

          # Generate comparison report
          REPORT_FILE="benchmark-comparison.md"
          echo "# Benchmark Comparison" > "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "**Base:** \`${{ github.base_ref }}\` @ $(echo "$BASE_ENTRY" | jq -r '.git_commit[:7]')" >> "$REPORT_FILE"
          echo "**PR:** \`${{ github.head_ref }}\` @ $(echo "$PR_ENTRY" | jq -r '.git_commit[:7]')" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"

          # Compare criterion results
          echo "## Criterion Benchmarks" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "$BASE_ENTRY" "$PR_ENTRY" | jq -rs '
            .[0] as $base | .[1] as $pr |
            $base.criterion_results as $base_crit |
            $pr.criterion_results as $pr_crit |
            $pr_crit | keys | sort[] | . as $bench_name |
            $base_crit[$bench_name] // null | . as $base_result |
            $pr_crit[$bench_name] | . as $pr_result |
            if $base_result != null then
              ($pr_result.mean.point_estimate / $base_result.mean.point_estimate - 1) * 100 | . as $change |
              ($change | if . > 5 then ":chart_with_upwards_trend:" elif . < -5 then ":chart_with_downwards_trend:" else ":left_right_arrow:" end) as $icon |
              "- **\($bench_name)**: \($pr_result.mean.point_estimate / 1000000 * 1000 | round / 1000)ms (base: \($base_result.mean.point_estimate / 1000000 * 1000 | round / 1000)ms) \($icon) **\($change * 100 | round / 100)%**"
            else
              "- **\($bench_name)**: \($pr_result.mean.point_estimate / 1000000 * 1000 | round / 1000)ms :sparkles: (new benchmark)"
            end
          ' >> "$REPORT_FILE"

          # Compare hyperfine results
          echo "" >> "$REPORT_FILE"
          echo "## Hyperfine Benchmarks" >> "$REPORT_FILE"
          echo "" >> "$REPORT_FILE"
          echo "$BASE_ENTRY" "$PR_ENTRY" | jq -rs '
            .[0] as $base | .[1] as $pr |
            $base.hyperfine_results as $base_hyper |
            $pr.hyperfine_results as $pr_hyper |
            $pr_hyper | keys | sort[] | . as $file_name |
            $base_hyper[$file_name] // null | . as $base_result |
            $pr_hyper[$file_name] | . as $pr_result |
            if $base_result != null and ($base_result.results | length > 0) and ($pr_result.results | length > 0) then
              ($pr_result.results[0].mean / $base_result.results[0].mean - 1) * 100 | . as $change |
              ($change | if . > 5 then ":chart_with_upwards_trend:" elif . < -5 then ":chart_with_downwards_trend:" else ":left_right_arrow:" end) as $icon |
              "- **\($file_name)**: \($pr_result.results[0].mean * 1000 | round / 1000)s (base: \($base_result.results[0].mean * 1000 | round / 1000)s) \($icon) **\($change * 100 | round / 100)%**"
            elif ($pr_result.results | length > 0) then
              "- **\($file_name)**: \($pr_result.results[0].mean * 1000 | round / 1000)s :sparkles: (new benchmark)"
            else
              empty
            end
          ' >> "$REPORT_FILE"

          cat "$REPORT_FILE"
      - name: Upload benchmark history artifact
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.6.2
        with:
          name: benchmark-history
          path: website/_data/benchmark-history.json
      - name: Comment PR
        if: success()
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
        with:
          script: |
            const fs = require('fs');
            const reportPath = 'benchmark-comparison.md';
            if (fs.existsSync(reportPath)) {
              const report = fs.readFileSync(reportPath, 'utf8');
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: report
              });
            }

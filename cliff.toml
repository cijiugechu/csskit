# git-cliff ~ configuration file
# https://git-cliff.org/docs/configuration

[changelog]
# A Tera template to be rendered for each release in the changelog.
# See https://keats.github.io/tera/docs/#introduction
body = """
{% if version %}\
    ## [{{ version | trim_start_matches(pat="v") }}] - {{ timestamp | date(format="%Y-%m-%d") }}
{% else %}\
    ## [unreleased]
{% endif %}\
{% for group, commits in commits | group_by(attribute="group") %}
    ### {{ group | striptags | trim | upper_first }}
    {% for commit in commits %}
        {%- set msg = commit.message | split(pat="\n") | first | trim -%}
        - {% if commit.breaking %}[**breaking**] {% endif %}{{ msg | upper_first }}{% if commit.links %} ([{{ commit.links[0].text }}]({{ commit.links[0].href }})){% endif %}
    {% endfor %}
{% endfor %}
"""
# Remove leading and trailing whitespaces from the changelog's body.
trim = true
# Render body even when there are no releases to process.
render_always = true
# An array of regex based postprocessors to modify the changelog.
postprocessors = [
	# Remove the crate tags from the final output
	{ pattern = '- (\[.*?\] )?\[.+?\] ', replace = "- " },
]

[git]
conventional_commits = false
filter_unconventional = false
require_conventional = false
split_commits = false
tag_pattern = "v[0-9].*"
# Use custom script to prepend crate tags to commit messages based on files changed
commit_preprocessors = [
	{ pattern = ".*", replace_command = ".mise-tasks/cliff-crate-tagger" },
]
protect_breaking_commits = false
# Group commits by the crate tags prepended by the preprocessor
commit_parsers = [
	# Skip commits with empty messages (filtered by preprocessor)
	{ message = "^$", skip = true },
	{ message = "^\\s*$", skip = true },
	# Extract the crate name from the tag and use it as the group
	# Pattern: [crate_name] message -> group by crate_name
	{ message = "^\\[(.+?)\\].*", group = "$1" },
	# Default group for commits without crate tags
	{ message = ".*", group = "Other Changes" },
]
filter_commits = false
# Extract PR links from commit messages
link_parsers = [
	{ pattern = "#(\\d+)", href = "https://github.com/csskit/csskit/pull/$1", text = "#$1" },
]
use_branch_tags = false
topo_order = false
sort_commits = "oldest"

# Bump settings - determine version based on PR labels
[bump]
initial_tag = "v0.0.5"
# Features with major label → major version bump
# Features with minor label → minor version bump
# Otherwise → patch version bump
features_always_bump_minor = false
breaking_always_bump_major = false
custom_major_increment_regex = ".*\\[major\\].*"
custom_minor_increment_regex = ".*\\[minor\\].*"
